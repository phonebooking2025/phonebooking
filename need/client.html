<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Panel - Date Time Fix</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; padding-bottom: 60px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        
        /* HEADER STYLES */
        .header { 
            background-color: #264D59; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            border-radius: 0 0 15px 15px; 
            position: relative; 
            overflow: hidden;   
            z-index: 1;
        }
        #header-bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; z-index: -1;
        }
        .header h1, .app-logo, .live-time { position: relative; z-index: 2; text-shadow: 0 2px 4px rgba(0,0,0,0.7); }
        .app-logo { max-width: 80px; max-height: 80px; border-radius: 50%; border: 2px solid white; margin-bottom: 5px; display: none; margin-left: auto; margin-right: auto;}
        .live-time { font-size: 1em; color: #ffeb3b; font-weight: bold; margin-top: 5px; font-family: monospace; }
        
        /* Banner Slider */
        .banner-slider { position: relative; width: 100%; height: 200px; margin-top: 10px; overflow: hidden; border-radius: 0 0 10px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background: #ddd; }
        .banner-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s ease-in-out; }
        .banner-img.active { opacity: 1; }

        /* Amazon Style Offer Badge */
        .offer-badge {
            position: absolute; top: 0; left: 0; background: #cc0c39; color: white;
            padding: 4px 10px; border-radius: 8px 0 15px 0; font-size: 0.8em; font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }

        /* Promo Video */
        .promo-video-container { margin: 20px 0; display: flex; flex-direction: column; gap: 15px; }
        .promo-video { width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); background: black; display: block; }
        .video-title { background: #264D59; color: white; padding: 5px 10px; border-radius: 5px 5px 0 0; font-size: 0.9em; margin-bottom: -5px; z-index: 1; position: relative; }

        /* Layout */
        .split-container { display: flex; flex-direction: row; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .split-section { flex: 1; min-width: 45%; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section-title { color: #264D59; border-bottom: 2px solid #264D59; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        
        .product-card { border: 1px solid #eee; border-radius: 8px; padding: 10px; text-align: center; background: white; position: relative; overflow: hidden; }
        .product-card img { width: 100%; height: 120px; object-fit: contain; margin-bottom: 5px; margin-top: 15px; }
        .product-card h3 { font-size: 0.9em; margin: 5px 0; height: 35px; overflow: hidden; }
        
        .b1g1-text { 
            color: #E91E63; font-weight: 900; font-size: 0.85em; margin: 4px 0; display: block;
            text-transform: uppercase; letter-spacing: 0.5px; text-shadow: 0px 0px 1px rgba(0,0,0,0.1);
        }

        .p-mkt { text-decoration: line-through; color: #999; font-size: 0.8em; margin: 2px 0; }
        .p-net { color: #264D59; font-weight: bold; font-size: 1em; margin: 2px 0; }
        .p-stk { color: #d32f2f; font-size: 0.8em; font-weight: bold; margin: 2px 0; }
        
        .btn { width: 100%; padding: 12px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 1em; }
        .btn-view { background: #232f3e; } 
        .btn-emi { background: #ff9800; }
        .btn-green { background: #28a745; }

        .page { display: none; }
        .page.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 3px; }
        .form-group input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; text-align: center; max-width: 80%; }
        .tick-icon { font-size: 50px; color: green; display: block; margin-bottom: 10px; }

        /* B1G1 Detail Page Styles - UPDATED */
        .b1g1-detail-box {
            display: none; 
            background: #fff0f5;
            border: 2px dashed #E91E63;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .b1g1-title { color: #E91E63; font-weight: 900; font-size: 1.4em; margin: 0; text-transform: uppercase; animation: pulse 1.5s infinite; }
        .b1g1-warn { color: red; font-size: 0.9em; font-weight: bold; margin: 5px 0; }
        
        /* New Style for Date Time Display */
        .b1g1-date-box {
            font-size: 1.1em;
            color: #333;
            font-weight: bold;
            margin-top: 8px;
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            border: 1px solid #ffcdd2;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Chat & WhatsApp Buttons */
        .chat-btn { position: fixed; bottom: 20px; right: 20px; background: #007bff; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1500; }
        .chat-box { display: none; position: fixed; bottom: 80px; right: 20px; width: 300px; max-width: 90%; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1500; flex-direction: column; overflow: hidden; height: 400px; }
        .chat-header { background: #007bff; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .chat-input { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        .chat-input input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .msg-bubble { margin-bottom: 10px; padding: 8px; border-radius: 5px; font-size: 0.9em; }
        .msg-user { background: #dcf8c6; align-self: flex-end; text-align: right; margin-left: 20%; }
        .msg-admin { background: #fff; border: 1px solid #ddd; text-align: left; margin-right: 20%; }

        .whatsapp-btn { position: fixed; bottom: 85px; right: 20px; width: 50px; height: 50px; background: linear-gradient(#25d366, #25d366); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1500; display: flex; align-items: center; justify-content: center; }
        .whatsapp-btn svg { width: 30px; height: 30px; fill: white; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1)); }
    </style>
</head>
<body>

    <div class="header">
        <div id="header-bg-layer"></div>
        <img id="top-logo" class="app-logo">
        <h1>Booking Now</h1>
        <div id="date-time" class="live-time">Loading...</div>
    </div>
    
    <div id="main-banners" class="banner-slider"></div>

    <div class="container">
        <div id="home-page" class="page active">
            <div class="split-container">
                <div class="split-section">
                    <div class="section-title">Mobile Items</div>
                    <div class="product-list" id="list-mob"></div>
                </div>
                <div class="split-section">
                    <div class="section-title">Other Items</div>
                    <div class="product-list" id="list-home"></div>
                </div>
            </div>

            <div id="promo-videos" class="promo-video-container"></div>

            <button class="btn btn-view" style="margin-top:20px; font-weight:bold;" onclick="showHistory()">View My Orders</button>
        </div>

        <div id="details-page" class="page" style="background:white; padding:15px; border-radius:10px;">
            <button onclick="goHome()">Back</button>
            <h2 id="dt-model"></h2>
            <img id="dt-img" style="width:200px; display:block; margin:0 auto;">
            <div id="dt-vid"></div>
            <p id="dt-desc" style="background:#f9f9f9; padding:10px;"></p>
            <h3 style="color:#264D59;">Netpay Price: â‚¹<span id="dt-price"></span></h3>
            
            <div id="b1g1-area" class="b1g1-detail-box">
                <div class="b1g1-title">BUY 1 GET 1 FREE</div>
                <div class="b1g1-warn">(This offer is valid for Netpay only)</div>
                <div style="font-size:0.9em; margin-top:5px; color:#555;">Offer Ends On:</div>
                <div id="b1g1-date-display" class="b1g1-date-box"></div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-view" onclick="toForm('NP')">Netpay Buy</button>
                <button class="btn btn-emi" onclick="toForm('EMI')">EMI Pay</button>
            </div>
        </div>

        <div id="form-page" class="page" style="background:white; padding:15px; border-radius:10px;">
            <button onclick="showPage('details-page')">Back</button>
            <h2 id="form-head"></h2>
            <div class="form-group"><label>Name</label><input id="inp-name" placeholder="Enter Name"></div>
            <div class="form-group"><label>Mobile</label><input type="number" id="inp-mob" placeholder="Enter Mobile"></div>
            <div class="form-group"><label>Address</label><textarea id="inp-addr" placeholder="Enter Full Address"></textarea></div>
            <div id="emi-fields" style="display:none; border-top: 1px solid #ccc; padding-top: 10px;">
                <div class="form-group"><label>Aadhar / Driving License Number</label><input type="text" id="inp-aadhar"></div>
                <div class="form-group"><label>Bank Details</label><textarea id="inp-bank"></textarea></div>
                <div class="form-group"><label>Your Photo</label><input type="file" id="inp-photo" accept="image/*"></div>
                <div class="form-group"><label>Select Plan</label><select id="inp-plan" onchange="calcEmi()"></select></div>
                <div style="background:#fff3e0; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <p style="margin:5px 0;">Monthly EMI: <b id="emi-val" style="color:red; font-size:1.2em;">â‚¹0</b></p>
                    <p style="margin:5px 0;">Down Payment: <b id="emi-dp-display" style="color:green; font-size:1.2em;">â‚¹0</b></p>
                </div>
            </div>
            <button class="btn btn-green" onclick="validateAndNext()">Next Pay</button>
        </div>

        <div id="qr-page" class="page" style="background:white; padding:15px; border-radius:10px; text-align:center;">
            <button onclick="showPage('form-page')" style="float:left;">Back</button>
            <br><h2 style="margin-top:10px;">Scan & Pay</h2>
            <div style="background:#e8f5e9; padding:10px; margin-bottom:15px; border-radius:5px;">
                <h3 id="pay-label" style="margin:0;">Pay Amount</h3><h1 id="pay-amt" style="color:green; margin:5px 0;"></h1>
            </div>
            <img id="qr-img" style="width:100%; max-width:250px; border:2px solid #333;">
            <div class="form-group" style="margin-top:20px; text-align:left;"><label>Upload Payment Screenshot (Required)</label><input type="file" id="inp-ss" accept="image/*"></div>
            <button class="btn btn-green" onclick="finishOrder()">OK - Complete Order</button>
        </div>

        <div id="hist-page" class="page" style="background:white; padding:15px;">
            <button onclick="goHome()">Back</button>
            <h2>My Orders</h2>
            <div id="hist-list"></div>
        </div>
    </div>

    <div id="popup" class="modal">
        <div class="modal-content"><span class="tick-icon">âœ…</span><p id="pop-txt" style="font-size:1.1em; font-weight:bold;"></p></div>
    </div>

    <div class="whatsapp-btn" onclick="openWhatsApp()">
        <svg viewBox="0 0 24 24">
            <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
        </svg>
    </div>

    <div class="chat-btn" onclick="toggleChat()">ðŸ’¬</div>
    <div class="chat-box" id="chat-window">
        <div class="chat-header"><span>Customer Support</span><span onclick="toggleChat()" style="cursor:pointer;">âœ–</span></div>
        <div class="chat-msgs" id="chat-msgs-area"></div>
        <div class="chat-input">
            <input type="text" id="chat-inp" placeholder="Message...">
            <button onclick="sendMsg()" style="background:#007bff; color:white; border:none; border-radius:3px; margin-left:5px;">âž¤</button>
        </div>
    </div>

    <script>
        const KEYS = { 
            MOB: 'admin_mobiles_data', HOME: 'admin_home_appliances_data', NP: 'user_netpay_sales', EMI: 'user_emi_sales', 
            LOGO: 'admin_app_logo', CHAT: 'app_chat_data', BANNERS: 'admin_banners_data', VIDEOS: 'admin_promo_videos_data',
            HEAD_BG: 'admin_header_bg', HEAD_OP: 'admin_header_opacity',
            WHATSAPP: 'admin_whatsapp_number'
        };
        let curItem = null, type = '';
        let currentSlide = 0;

        function init() {
            renderList(KEYS.MOB, 'list-mob');
            renderList(KEYS.HOME, 'list-home');
            loadLogo();
            loadHeaderBg();
            loadBanners(); 
            loadVideos(); 
            updateClock();
            setInterval(updateClock, 1000); 
            renderUserChat();
        }

        // WhatsApp Function
        function openWhatsApp() {
            const num = localStorage.getItem(KEYS.WHATSAPP);
            if(!num) { alert("WhatsApp Support currently unavailable (Number not set by Admin)."); return; }
            const url = `https://wa.me/${num}?text=Hi, I would like to know about your products.`;
            window.open(url, '_blank');
        }

        function loadHeaderBg() {
            const bg = localStorage.getItem(KEYS.HEAD_BG);
            const op = localStorage.getItem(KEYS.HEAD_OP) || '0.5';
            const layer = document.getElementById('header-bg-layer');
            if(bg) { layer.style.backgroundImage = `url('${bg}')`; layer.style.opacity = op; }
        }

        function loadLogo() {
            const l = localStorage.getItem(KEYS.LOGO);
            if(l) { document.getElementById('top-logo').src = l; document.getElementById('top-logo').style.display = 'block'; }
        }

        function loadBanners() {
            const div = document.getElementById('main-banners');
            const banners = JSON.parse(localStorage.getItem(KEYS.BANNERS)) || [];
            div.innerHTML = '';
            if(banners.length > 0) {
                div.style.display = 'block';
                banners.forEach((src, index) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = index === 0 ? 'banner-img active' : 'banner-img';
                    div.appendChild(img);
                });
                if(banners.length > 1) {
                    setInterval(() => {
                        const allImages = document.querySelectorAll('.banner-img');
                        allImages[currentSlide].classList.remove('active'); 
                        currentSlide = (currentSlide + 1) % allImages.length; 
                        allImages[currentSlide].classList.add('active'); 
                    }, 3000);
                }
            } else { div.style.display = 'none'; }
        }

        function loadVideos() {
            const div = document.getElementById('promo-videos');
            const videos = JSON.parse(localStorage.getItem(KEYS.VIDEOS)) || [];
            div.innerHTML = '';
            if(videos.length > 0) {
                videos.forEach((v, index) => {
                    div.innerHTML += `<div><div class="video-title">Special Offer Video ${index+1}</div><video src="${v}" controls class="promo-video"></video></div>`;
                });
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('date-time').innerText = now.toLocaleDateString('en-IN') + ' ' + now.toLocaleTimeString('en-IN');
        }

        function renderList(k, id) {
            const div = document.getElementById(id); div.innerHTML='';
            (JSON.parse(localStorage.getItem(k))||[]).forEach(x => {
                const b1g1Html = x.buyOneGetOne === 'Yes' ? '<span class="b1g1-text">BUY 1 GET 1 FREE</span>' : '';
                div.innerHTML += `
                <div class="product-card">
                    ${x.offer ? `<div class="offer-badge">${x.offer}</div>` : ''} 
                    <img src="${x.image}">
                    <h3 style="margin-top:5px;">${x.model}</h3>
                    ${b1g1Html}
                    <p class="p-mkt">Market: â‚¹${x.bookingAmount}</p>
                    <p class="p-net">Netpay: â‚¹${x.netpayPrice}</p>
                    <p class="p-stk">Stock: ${x.stock || 'N/A'}</p>
                    <button class="btn btn-view" style="padding:5px;" onclick="det('${x.id}')">View</button>
                </div>`;
            });
        }

        function det(id) {
            const all = [...(JSON.parse(localStorage.getItem(KEYS.MOB))||[]), ...(JSON.parse(localStorage.getItem(KEYS.HOME))||[])];
            curItem = all.find(x=>x.id==id);
            document.getElementById('dt-model').innerText = curItem.model;
            document.getElementById('dt-img').src = curItem.image;
            document.getElementById('dt-vid').innerHTML = curItem.video ? `<video src="${curItem.video}" controls style="width:100%"></video>` : '';
            document.getElementById('dt-desc').innerText = curItem.fullSpecs;
            document.getElementById('dt-price').innerText = curItem.netpayPrice;

            // --- B1G1 LOGIC: SHOW DATE ONLY ---
            const b1g1Area = document.getElementById('b1g1-area');
            const b1g1DateDisplay = document.getElementById('b1g1-date-display');
            
            if (curItem.buyOneGetOne === 'Yes') {
                b1g1Area.style.display = 'block';
                if(curItem.offerEndTime) {
                    const dateObj = new Date(curItem.offerEndTime);
                    // Format: 30/12/2025 at 10:00 PM
                    const dateStr = dateObj.toLocaleDateString('en-GB'); // DD/MM/YYYY
                    const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                    b1g1DateDisplay.innerText = `${dateStr} at ${timeStr}`;
                    b1g1DateDisplay.style.color = "#d32f2f"; // Red color for urgency
                } else {
                    b1g1DateDisplay.innerText = "Limited Time Offer!";
                    b1g1DateDisplay.style.color = "#333";
                }
            } else {
                b1g1Area.style.display = 'none';
            }

            showPage('details-page');
        }

        function toForm(t) {
            type = t;
            document.getElementById('form-head').innerText = t==='NP'?'Netpay Details':'EMI Application';
            document.getElementById('emi-fields').style.display = t==='EMI'?'block':'none';
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
            if(t==='EMI') {
                const s = document.getElementById('inp-plan'); s.innerHTML='';
                (curItem.emiMonths||"3").split(',').forEach(m=>s.innerHTML+=`<option value="${m}">${m} Months</option>`);
                calcEmi();
            }
            showPage('form-page');
        }

        function calcEmi() {
            const m = parseInt(document.getElementById('inp-plan').value);
            let dp = 0;
            if (curItem.downPaymentAmount && curItem.downPaymentAmount > 0) { dp = parseInt(curItem.downPaymentAmount); } 
            else { dp = Math.round(curItem.netpayPrice * 0.3); }

            const p = curItem.netpayPrice - dp;
            const emi = Math.round((p + (p*0.15)) / m);
            document.getElementById('emi-val').innerText = 'â‚¹' + emi;
            document.getElementById('emi-dp-display').innerText = 'â‚¹' + dp;
        }

        function validateAndNext() {
            const name = document.getElementById('inp-name').value;
            const mob = document.getElementById('inp-mob').value;
            const addr = document.getElementById('inp-addr').value;
            if(!name || !mob || !addr) return alert("Fill all details!");
            if(type === 'EMI') {
                if(!document.getElementById('inp-aadhar').value || !document.getElementById('inp-bank').value || !document.getElementById('inp-photo').files[0]) return alert("Fill ID, Bank and Photo!");
            }
            
            let dp = 0;
            if (curItem.downPaymentAmount && curItem.downPaymentAmount > 0) { dp = parseInt(curItem.downPaymentAmount); } 
            else { dp = Math.round(curItem.netpayPrice * 0.3); }

            const payAmt = type === 'NP' ? curItem.netpayPrice : dp;
            document.getElementById('pay-label').innerText = type === 'NP' ? 'Total Netpay' : 'Down Payment';
            document.getElementById('pay-amt').innerText = 'â‚¹' + payAmt;
            document.getElementById('qr-img').src = curItem.netpayQrCode;
            showPage('qr-page');
        }

        async function finishOrder() {
            const ss = document.getElementById('inp-ss').files[0];
            if(!ss) return alert("Upload Screenshot!");
            
            const ord = {
                id: Date.now(),
                model: curItem.model,
                name: document.getElementById('inp-name').value,
                mobile: document.getElementById('inp-mob').value,
                address: document.getElementById('inp-addr').value,
                screenshot: await readFile(ss),
                status: 'Pending',
                deliveryDate: null
            };

            if(type === 'EMI') {
                ord.userPhoto = await readFile(document.getElementById('inp-photo').files[0]);
                ord.aadhar = document.getElementById('inp-aadhar').value;
                ord.bankDetails = document.getElementById('inp-bank').value;
                ord.months = document.getElementById('inp-plan').value;
                let dp = 0;
                if (curItem.downPaymentAmount && curItem.downPaymentAmount > 0) { dp = parseInt(curItem.downPaymentAmount); } 
                else { dp = Math.round(curItem.netpayPrice * 0.3); }
                ord.downPayment = dp;
                const ls = JSON.parse(localStorage.getItem(KEYS.EMI))||[]; ls.push(ord);
                localStorage.setItem(KEYS.EMI, JSON.stringify(ls));
            } else {
                ord.price = curItem.netpayPrice;
                const ls = JSON.parse(localStorage.getItem(KEYS.NP))||[]; ls.push(ord);
                localStorage.setItem(KEYS.NP, JSON.stringify(ls));
            }

            const popMsg = type === 'EMI' ? "Your ordered mobile will be delivered to your home address in 25 days." : "Your ordered mobile will be delivered to your home address in 19 days.";
            document.getElementById('pop-txt').innerText = popMsg;
            document.getElementById('popup').style.display = 'flex';
            setTimeout(() => { location.reload(); }, 4000);
        }

        function showHistory() {
            const div = document.getElementById('hist-list'); div.innerHTML='';
            const np = JSON.parse(localStorage.getItem(KEYS.NP))||[];
            const emi = JSON.parse(localStorage.getItem(KEYS.EMI))||[];
            if(!np.length && !emi.length) div.innerHTML = '<p>No orders yet.</p>';
            const renderItem = (o, t) => {
                let delTxt = '';
                if(o.status === 'Confirmed' && o.deliveryDate) {
                    delTxt = `<span style="color:green; font-weight:bold; display:block;">Delivery on: ${new Date(o.deliveryDate).toDateString()}</span>`;
                }
                return `<div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
                    <strong>${o.model} (${t})</strong><br>
                    Status: ${o.status}
                    ${delTxt}
                </div>`;
            };
            np.forEach(o => div.innerHTML += renderItem(o, 'Netpay'));
            emi.forEach(o => div.innerHTML += renderItem(o, 'EMI'));
            showPage('hist-page');
        }

        function toggleChat() { const w = document.getElementById('chat-window'); w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; }
        function sendMsg() {
            const inp = document.getElementById('chat-inp'); const txt = inp.value.trim();
            if(!txt) return;
            const chats = JSON.parse(localStorage.getItem(KEYS.CHAT)) || [];
            chats.push({ message: txt, reply: '', time: new Date().toLocaleTimeString(), id: Date.now() });
            localStorage.setItem(KEYS.CHAT, JSON.stringify(chats));
            inp.value = ''; renderUserChat();
        }
        function renderUserChat() {
            const area = document.getElementById('chat-msgs-area'); const chats = JSON.parse(localStorage.getItem(KEYS.CHAT)) || [];
            area.innerHTML = '';
            chats.forEach(c => {
                area.innerHTML += `<div class="msg-bubble msg-user">${c.message}</div>`;
                if(c.reply) area.innerHTML += `<div class="msg-bubble msg-admin"><strong>Admin:</strong> ${c.reply}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        }

        function showPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }
        function goHome() { showPage('home-page'); }
        function readFile(f) { return new Promise(r=>{const rd=new FileReader(); rd.onload=e=>r(e.target.result); rd.readAsDataURL(f);}); }
        window.onload = init;
    </script>
</body>
</html>